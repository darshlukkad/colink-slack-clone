name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  EC2_HOST: 43.205.118.54
  EC2_USER: ec2-user
  DEPLOY_PATH: /home/ec2-user/colink-slack-clone

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/colink.pem
          chmod 600 ~/.ssh/colink.pem
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on EC2
        run: |
          ssh -i ~/.ssh/colink.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} "mkdir -p ${{ env.DEPLOY_PATH }}"

      - name: Copy files to EC2
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '.pytest_cache' \
            --exclude 'htmlcov' \
            --exclude '.env.local' \
            -e "ssh -i ~/.ssh/colink.pem" \
            ./ ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Create .env file on EC2
        run: |
          ssh -i ~/.ssh/colink.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            cat > .env << 'ENVFILE'
          PUBLIC_IP=${{ env.EC2_HOST }}
          KEYCLOAK_REALM=colink
          KEYCLOAK_CLIENT_ID=web-app
          DATABASE_URL=postgresql+asyncpg://colink:colink_password@postgres:5432/colink
          REDIS_URL=redis://redis:6379/0
          KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
          MINIO_ENDPOINT=minio:9000
          MINIO_ACCESS_KEY=minioadmin
          MINIO_SECRET_KEY=minioadmin
          ENVFILE
          EOF

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/colink.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            cd ${{ env.DEPLOY_PATH }}
            
            # Stop existing containers (but keep volumes)
            docker compose down --remove-orphans || docker-compose down --remove-orphans || echo "No containers running"
            
            # Pull latest base images
            docker compose pull || docker-compose pull || echo "Pull completed"
            
            # Build and start infrastructure services first
            export PUBLIC_IP=${{ env.EC2_HOST }}
            docker compose up -d --build postgres redis redpanda minio opensearch prometheus || \
              docker-compose up -d --build postgres redis redpanda minio opensearch prometheus
            
            # Wait for postgres to be ready
            echo "Waiting for PostgreSQL to be ready..."
            for i in {1..30}; do
              if docker exec colink-postgres pg_isready -U colink > /dev/null 2>&1; then
                echo "PostgreSQL is ready"
                break
              fi
              echo "Waiting for PostgreSQL... ($i/30)"
              sleep 2
            done
            
            # Ensure keycloak database exists
            docker exec colink-postgres psql -U colink -d colink -tc "SELECT 1 FROM pg_database WHERE datname = 'keycloak'" | grep -q 1 || \
              docker exec colink-postgres psql -U colink -d colink -c "CREATE DATABASE keycloak;"
            echo "Keycloak database ensured"
            
            # Start all remaining services
            docker compose up -d --build || docker-compose up -d --build
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 45
            
            # Show container status
            docker compose ps || docker-compose ps
          EOF

      - name: Health check
        run: |
          ssh -i ~/.ssh/colink.pem ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            echo "=== Container Status ==="
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            
            echo ""
            echo "=== Health Checks ==="
            
            # Check frontend
            curl -sf http://localhost:3000 > /dev/null && echo "✓ Frontend is healthy" || echo "✗ Frontend is not responding"
            
            # Check auth-proxy (follow redirects)
            curl -sfL http://localhost:8001/health/ > /dev/null && echo "✓ Auth-proxy is healthy" || echo "✗ Auth-proxy is not responding"
            
            # Check message service
            curl -sfL http://localhost:8002/health/ > /dev/null && echo "✓ Message service is healthy" || echo "✗ Message service is not responding"
            
            # Check channel service
            curl -sfL http://localhost:8003/health/ > /dev/null && echo "✓ Channel service is healthy" || echo "✗ Channel service is not responding"
            
            # Check keycloak
            curl -sf http://localhost:8080 > /dev/null && echo "✓ Keycloak is healthy" || echo "✗ Keycloak is not responding"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/colink.pem
